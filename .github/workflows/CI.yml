name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: 'no'
  release:
    types: [published]

jobs:
  build:
    name: Build RT-N14U Firmware
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - build_variant: "mt7620"
            target: "RT-N14U"

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libtool-bin gperf python3-docutils autopoint gettext bc bison flex p7zip-full

      # 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤
      - name: Run shellcheck
        run: sh ./trunk/tools/shellcheck.sh

      # 4Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ toolchain
      - name: Prepare toolchain
        run: |
          cd toolchain-mipsel
          sh dl_toolchain.sh

      # 5Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tmate (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.debug_enabled == 'yes' }}
        with:
          limit-access-to-actor: true

      # 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ .config
      - name: Check kernel config
        run: |
          cd trunk/linux-3.4.x
          if [ -f ../configs/boards/RT-N14U/kernel-3.4.x.config ]; then
            echo ".config exists ‚úÖ"
            cp ../configs/boards/RT-N14U/kernel-3.4.x.config .config
          else
            echo "ERROR: kernel-3.4.x.config missing ‚ùå"
            ls -l ../configs/boards/RT-N14U/
            exit 1
          fi
          cd ../..

      # 7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ toolchain MIPS
      - name: Check MIPS toolchain
        run: |
          export PATH="${{ github.workspace }}/toolchain-mipsel/toolchain-3.4.x/bin:$PATH"
          export CROSS_COMPILE=mipsel-linux-uclibc-
          which ${CROSS_COMPILE}gcc
          ${CROSS_COMPILE}gcc -v

      # 8Ô∏è‚É£ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —è–¥—Ä–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      - name: Prepare kernel
        run: |
          cd trunk/linux-3.4.x
          export PATH="${{ github.workspace }}/toolchain-mipsel/toolchain-3.4.x/bin:$PATH"
          export ARCH=mips
          export CROSS_COMPILE=mipsel-linux-uclibc-
          export KCONFIG_NOSILENTUPDATE=1

          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —è–¥—Ä–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞
          yes "" | make oldconfig

          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –¥–µ—Ä–µ–≤–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          make -j$(nproc) prepare

          # –°–æ–∑–¥–∞—ë–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã Makefile –Ω–µ –ø–∞–¥–∞–ª
          touch .config include/config/auto.conf include/generated/autoconf.h

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º auto.conf
          if [ ! -f include/config/auto.conf ]; then
            echo "ERROR: include/config/auto.conf not created ‚ùå"
            exit 1
          else
            echo "include/config/auto.conf exists ‚úÖ"
          fi
          cd ../..

      # 9Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏
      - name: Build firmware
        run: |
          cd trunk
          export PATH="${{ github.workspace }}/toolchain-mipsel/toolchain-3.4.x/bin:$PATH"
          export ARCH=mips
          export CROSS_COMPILE=mipsel-linux-uclibc-

          # –ú–µ–Ω—è–µ–º IP (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          find ./ -type f -name "*" -print0 | xargs -0 sed -i 's/192.168.1.1/192.168.10.1/g'

          # –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ—à–∏–≤–∫–∏
          fakeroot ./build_firmware_ci RT-N14U

      # üîü –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ –ø—Ä–æ—à–∏–≤–∫–∏
      - name: Create archive
        if: ${{ github.event_name != 'release' && success() }}
        run: |
          images_dir=/opt/images
          ls -lh ${images_dir}
          GIT_VERSION=$(git rev-parse --short=7 HEAD 2>/dev/null)
          if [ -n "$GIT_VERSION" ]; then
            image_name=images_${{ matrix.build_variant }}_${GIT_VERSION}
          else
            image_name=images_${{ matrix.build_variant }}
          fi
          cd ${images_dir}
          md5sum *.trx | tee md5sum.txt
          7z a -mx=9 ${image_name}.7z ./*
          echo "image_name=${image_name}" >> $GITHUB_ENV

      # 1Ô∏è‚É£1Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Padavan-Firmware-Files
          path: /opt/images/

